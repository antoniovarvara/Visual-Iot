<meta charset="utf-8">
<title>Fire-IoT Logger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
<link
        href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css"
        rel="stylesheet">
<script
        src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.js"></script>
<script>
    $(function() {
        $( "#startdate" ).datepicker({
            defaultDate: "-1d",
            changeMonth: true,
            numberOfMonths: 1,
            onClose: function( selectedDate ) {
                $( "#enddate" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#enddate" ).datepicker({
            defaultDate: "+1d",
            changeMonth: true,
            numberOfMonths: 1,
            onClose: function( selectedDate ) {
                $( "#startdate" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
    });
</script>
<style>
    [class*="sticky"] {
        z-index: 1; /* Stay on top */
        position: fixed;
        top: 0;
        width: 100%;
    }
    .btn-group button {
        background-color: #4CAF50; /* Green background */
        width: 160px;
        border: 1px solid green; /* Green border */
        color: white; /* White text */
        padding: 10px 24px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        display: block; /* Make the buttons appear below each other */
    }

    .btn-group button:not(:last-child) {
        border-bottom: none; /* Prevent double borders */
    }

    /* Add a background color on hover */
    .btn-group button:hover {
        background-color: #3e8e41;
    }
    /* The sidebar menu */
    .sidenav {
        height: 100%; /* Full-height: remove this if you want "auto" height */
        width: 160px; /* Set the width of the sidebar */
        position: fixed; /* Fixed Sidebar (stay in place on scroll) */
        z-index: 1; /* Stay on top */
        top: 0; /* Stay at the top */
        left: 0;
        background-color: #111; /* Black */
        overflow-x: hidden; /* Disable horizontal scroll */
        margin-top: 40px;
        padding-top: 20px;
    }

    /* The navigation menu links */
    .sidenav a {
        padding: 6px 8px 6px 16px;
        text-decoration: none;
        font-size: 25px;
        color: #818181;
        display: block;
    }

    /* When you mouse over the navigation links, change their color */
    .sidenav a:hover {
        color: #f1f1f1;
    }

    /* Style page content */
    .main {
        margin-left: 160px; /* Same as the width of the sidebar */
        padding: 0px 10px;
        margin-top: 60px;
    }
    .map {
        z-index: 1;
        position: absolute;
        margin-right: 10px;
        width : 400px;
        height : 400px;
        right: 0;
    }
</style>
</head>
<body>
<div class="navbar-sticky">
    <div class="navbar-inner">
        <a class="brand" href="#">Fire-IoT</a>
    </div>
</div>
<div id="map" class="map"></div>
<div id="main" class="main">
    <form action="/" id="searchForm">
        <table>
            <tr>
                <p>
                <td>Inzio:</td><td> <input type="text" id="startdate" name="startdate" ></td>
                <td>
                    <select name="starthour">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                    </select>
                </td>
                <td>
                    <select name="startminute">
                        <option value="0" selected>00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                </td>
                <td>        </td>
                </p>
            </tr>
            <tr>
                <p>
                <td>Fine: </td><td><input type="text" id="enddate" name="enddate"></td>
                <td>
                    <select name="endhour">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                    </select>
                </td>
                <td>
                    <select name="endminute">
                        <option value="0" selected>00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                </td>
                </p>
            </tr>
            <tr id="sens">
                <td></td>
                <td><input id="s1" type="radio" name="displayData" value="TempC">Temperatura (C)</td>
                <td><input id="s2" type="radio" name="displayData" value="Humidity">Umidit√†</td>
            </tr>
            <tr id="el">
                <td></td>
                <td><input id="s6" type="radio" name="displayData" value="TempC">Temperatura (C)</td>
                <td><input id="s3" type="radio" name="displayData" value="Smoke">Fumo</td>
                <td><input id="s4" type="radio" name="displayData" value="Fire">Fiamme</td>
                <td><input id="s5" type="radio" name="displayData" value="CO">CO</td>
            </tr>
            <tr>
                <td><input id="submitbutton" type="submit" value="Cerca"></td>
            </tr>
        </table>
    </form>
    <canvas id="myChart" width="700" height="400"></canvas>
    <div id="result"></div>
    <script type="text/javascript">
        function draw(labelsArray, dataArray) {
            var ctx = $("#myChart").get(0).getContext("2d");
            // set canvas dimensions
            ctx.canvas.width = 700;
            ctx.canvas.height = 400;

            var data = {
                labels : labelsArray,
                datasets : [ {
                    fillColor : "rgba(151,187,205,0.5)",
                    strokeColor : "rgba(151,187,205,1)",
                    pointColor : "rgba(151,187,205,1)",
                    pointStrokeColor : "#fff",
                    data : dataArray
                } ]
            }

            var myNewChart = new Chart(ctx).Line(data);
        }
    </script>
    <script>

        var sensorID = "fez";
        var markerMap = {};
        function showEspSensors() {
            document.getElementById("s1").checked = true;
            document.getElementById("s2").checked = false;
            document.getElementById("s3").checked = false;
            document.getElementById("s4").checked = false;
            document.getElementById("s5").checked = false;
            document.getElementById("s6").checked = false;
            document.getElementById("el").style.display = 'none';
            document.getElementById("sens").style.display = 'table-row';
            sensorID = "esp";
            if("esp" in markerMap) google.maps.event.trigger(markerMap["esp"], 'click');
        }

        function showFezSensors() {
            document.getElementById("s1").checked = false;
            document.getElementById("s2").checked = false;
            document.getElementById("s3").checked = false;
            document.getElementById("s4").checked = false;
            document.getElementById("s5").checked = false;
            document.getElementById("s6").checked = true;
            document.getElementById("el").style.display = 'table-row';
            document.getElementById("sens").style.display = 'none';
            sensorID = "fez";
            if("fez" in markerMap) google.maps.event.trigger(markerMap["fez"], 'click');
        }

        showFezSensors();
    </script>
    <script>
        var switchValue = "TempC";
        $.ajax({
            error: function(xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");
                alert(err.Message);
            }
        });
        $( "#searchForm" ).submit(function( event ) {

            // Stop form from submitting normally
            event.preventDefault();
            document.getElementById('submitbutton').disabled = true;
            // Get some values from elements on the page:
            var $form = $( this ),
                startdtxt = $form.find( "input[name='startdate']" ).val(),
                starthrtxt = $form.find( "select[name='starthour']" ).val(),
                startmintxt = $form.find( "select[name='startminute']" ).val(),
                enddtxt = $form.find( "input[name='enddate']" ).val(),
                endhrtxt = $form.find( "select[name='endhour']" ).val(),
                endmintxt = $form.find( "select[name='endminute']" ).val(),
                displayValue = $form.find( "input[name='displayData']:checked" ).val();
            switchValue = displayValue;

            var startdt = Date.parse(startdtxt) + (parseInt(starthrtxt) * 60 * 60 * 1000) + (parseInt(startmintxt) * 60 * 1000);
            var enddt = Date.parse(enddtxt) + (parseInt(endhrtxt) * 60 * 60 * 1000) + (parseInt(endmintxt) *  60 * 1000);
            //var url = "https://w5athzoxi6.execute-api.eu-west-1.amazonaws.com/prod/LambdaDhtGraph";
            var url = "http://52.57.156.220:1880/data"
            $.ajaxSetup({contentType: "application/json; charset=utf-8"});
            // Send the data using post
            var posting = $.get( url, {start: startdt, end: enddt, sensorID: sensorID, sensortype: switchValue});

            // Parse out the results
            posting.done(function( data ) {
                console.log(data);
                var input = JSON.parse(data);
                var result = input.result;
                // assume the data is an array of Javascript objects
                // should also deal with the empty case here and inform the user
                var length = result.length;
                if (length != 0) {
                    var maximum = 25;
                    var increment = (length <= maximum) ? 1 : Math.round(length/maximum);
                    var totalsize = (length <= maximum) ? length : maximum;
                    var timeArray=new Array(totalsize);
                    //var humidArray=new Array(totalsize);
                    //var tempCArray=new Array(totalsize);
                    var sensArray = new Array(totalsize);
                    for (var i = 0; i < totalsize; i++) {
                        var current = result[i*increment];
                        timeArray[i] =
                            moment(current.iso_timestamp).format('MM-DD-YY HH:mm');
                        //humidArray[i] = current.humidity;
                        //tempCArray[i] = current.temperature;
                        sensArray[i] = current.value;
                    }
                    console.log(timeArray);
                    /*
                    switch(switchValue) {
                        case "TempC":
                            draw(timeArray,tempCArray);
                            break;
                        default:
                            draw(timeArray, humidArray);
                    }
                    */
                    draw(timeArray, sensArray);
                    document.getElementById('submitbutton').disabled = false;
                } else {
                    console.log("no data");
                }
            }).fail(function() {
                alert( "error" );
            });
        });
    </script>
    <script>
        var infowindowArray = new Array();
        function closeMapInfoWindow(){
            for (var i = 0; i < infowindowArray.length; i++ ) {
                infowindowArray[i].close();
            }
        }
        function myMap() {
            var myCenter = new google.maps.LatLng(45.056471,7.653189);
            var mapCanvas = document.getElementById("map");
            var mapOptions = {center: myCenter, zoom: 15};
            var map = new google.maps.Map(mapCanvas, mapOptions);
            var marker = new google.maps.Marker({position:myCenter, map: map});
            markerMap["fez"] = marker;
            google.maps.event.addListener(marker,'click',function() {
                var infowindow = new google.maps.InfoWindow({content:"FEZ_24"});
                infowindowArray.push(infowindow);
                closeMapInfoWindow();
                infowindow.open(map,marker);
            });
            //close all the infoboxes when lose focus
            google.maps.event.addListener(map, "click", function(event) {
                closeMapInfoWindow();
            });
            var url = "http://52.57.156.220:1880/currentPositionTest"
            $.ajaxSetup({contentType: "application/json; charset=utf-8"});
            // Send the data using post
            var posting = $.get( url );
            // Parse out the results
            posting.done(function( data ) {
                var result = JSON.parse(data);
                // assume the data is an array of Javascript objects
                // should also deal with the empty case here and inform the user
                var length = result.length;
                if (length != 0) {
                    var positionResult = new google.maps.LatLng(result.location.lat,result.location.lng);
                    var markerPosition = new google.maps.Marker({position:positionResult, map: map});
                    markerMap["esp"] = markerPosition;
                    google.maps.event.addListener(markerPosition,'click',function() {
                        var infowindow = new google.maps.InfoWindow({content:"Temperature Sensor"});
                        infowindowArray.push(infowindow);
                        closeMapInfoWindow();
                        infowindow.open(map,markerPosition);
                    });
                    var markers = [marker, markerPosition];//some array
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0; i < markers.length; i++) {
                        bounds.extend(markers[i].getPosition());
                    }
                    map.fitBounds(bounds);
                } else {
                    console.log("no data");
                }
            }).fail(function() {
                alert( "error" );
            });
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBh0cT6vLIpkCqI9Fsogp6QSo8dXVyK8Cc&callback=myMap"></script>

</div>
<div id="sensorList" class="sidenav">
    <div class="btn-group">
        <button onclick="showFezSensors()">Fez</button>
        <button onclick="showEspSensors()">Temp</button>
    </div>
</body>
</html>